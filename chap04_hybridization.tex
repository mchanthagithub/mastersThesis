%% This is an example first chapter.  You should put chapter/appendix that you
%% write into a separate file, and add a line \include{yourfilename} to
%% main.tex, where `yourfilename.tex' is the name of the chapter/appendix file.
%% You can process specific files by typing their names in at the 
%% \files=
%% prompt when you run the file main.tex through LaTeX.
\newcommand{\pluseq}{\mathrel{{+}{=}}}
\chapter{Hybridization}
The previous two chapters described two very different modeling paradigms, both with their strengths and weaknesses. As mentioned in the introduction, the goal is to be able to utilize the strengths of both to offset their weaknesses in order to create a versatile method that can handle phenomena that span many magnitudes of length scales and all phases of granular matter. Namely, the goal is to utilize the accuracy of the discrete element method where it is needed, while in all other regions, using the continuum method to solve a simple continuum model with much fewer degrees of freedom than a full discrete simulation. The method to achieve this is subsequently explained.

\section{Hybridization Overview}
\begin{figure}[htp] 
    \centering
    \includegraphics[width=0.8\textwidth]{figs/hybrid_example.pdf}
    \caption{Diagram of a hybrid simulation.}
    \label{hybrid_diagram}
\end{figure}

Figure \ref{hybrid_diagram} gives a visual representation of a hybrid simulation of a collapsing pile of grains. On the exterior are discrete grains, modeled by DEM. On the interior is a region of continuum, utilizing MPM. A regime where both DEM and continuum overlap each other, what is deemed the "Reconciliation Zone" or "Hybrid Zone" (both are used interchangeably), then connects the two modeling regimes.

From this schematic there are a couple of things of note. A single MPM simulation is used to solve for the pure continuum region, as well as the continuum portion of the hybrid zone. The continuum region has only a single piece of information that delineates the pure continuum from the hybrid continuum: a weight field $w_c(x)$ that has a value of 1 in the pure continuum and a value between 0 and 1 in the hybrid regime. Likewise, a single DEM simulation is used to advance the state of the discrete grains in the pure discrete region as well as the discrete portion of the hybrid zone. Again, a weight field $w_d(x)$ delineates the pure discrete and hybrid regimes, with a value of 1 in the pure discrete region and a value between 0 and 1 in the hybrid region.

At a very high level the hybrid scheme can be described thusly. At the beginning of a hybrid timestep, the domain is decomposed into pure continuum, pure discrete, and hybrid regions. The determination of which region is represented with which model is conducted by what is termed the "oracle", which will be later explained. If the oracle determines that a region described by the continuum model needs greater accuracy, then a process called "enrichment" converts the continuum representation to a discrete representation. On the other hand, if the oracle determines that a discrete region no longer needs to be resolved to that level, then a process called "homogenization" converts that discrete representation into a continuum representation. A step of MPM for what regions are now continuum and a step of DEM for regions that are now discrete are then taken, with no communication between the two regimes other than the weightage split previously described, resulting in intermediary quantities of state. These steps will be referred to as "unconstrained" steps, as they are unconstrained of any coupling between the two distinct systems. A coupling step then acts to kinematically constrain the two partitioned systems in the hybrid zones. These updated quantities are communicated back to the DEM and MPM solvers, which results in the end of timestep quantities for the entire simulation.

The hybrid scheme can be split into three main components. The first is the nature of the split of the continuum and discrete representations in the hybrid zone. The second is the coupling of those two split regions such that they end the step kinematically constrained. The third is the domain decomposition, and the processes of homogenization and enrichment. 

\section{Reconciliation Zone Splitting}
\begin{figure}[htp] 
    \centering
    \includegraphics[width=0.8\textwidth]{figs/blurred_mass.pdf}
    \caption{Blurred Density: (Left) The reference domain $\Omega$ of an object with density $\rho(\bm{x})$. Mass density is colored in blue. (Right) A partition of unity of the density mediated by a weight function $w(\bm{x},t)$.}
    \label{blurred_mass}
\end{figure}

In order to understand the split of the system in the hybrid zone, we introduce a more general system. We start with a body defined over some domain $\Omega$, with a density field $\rho(\bm{x})$. In the hybrid scheme, the domain is decomposed into two different domains according to a weight function that is defined over time and space, $w(\bm{x},t)$ with a range between 0 and 1. The weight function $w$ allows us to decompose any field defined on the body into a linear combination of two separate fields. Taking the density as an example:
\begin{equation}
\rho(\bm{x})=w(\bm{x},t)\rho(\bm{x}) + (1-w(\bm{x},t))\rho(\bm{x})
\end{equation}
To further separate and define the subsystems, let $\bm{q}_1$ and $\bm{v}_1$ define the position and velocity respectively of the first system and $\bm{q}_2$ and $\bm{v}_2$ be the counterparts for the second system. If we impose the constraint that $\bm{q}_1=\bm{q}_2$, then, along with the weight field, we can recover the original system. If we further impose that the initial conditions of both systems are identical, such that $\bm{q}_1(t=0)=\bm{q}_2(t=0)$, then we can define the velocity constraint $\bm{c}(\bm{x},t)=\bm{v}_1(\bm{x},t)-\bm{v}_2(\bm{x},t)=0$.

In order to derive the equations of motion for this decomposed system subject to the velocity constraint $\bm{c}(bm{x},t)$, we formulate the problem in the context of Lagrangian mechanics, using Hamilton's Variational Principle \cite{Lanczos:2012}. From this point one, the time and space dependence on the quantities of interest are excluded for brevity. We introduce the kinetic energy $T$ and potential energy $U$ of the decomposed system, defined as
\begin{align}
\begin{aligned}
T &= \frac{1}{2} \int_\Omega \rho w \bm{v}_1^T \bm{v}_1 dV + \frac{1}{2} \int_\Omega \rho (1-w) \bm{v}_2^T \bm{v}_2 dV, \\
U &= \int_\Omega \rho w e[\bm{q}_1] dV + \int_\Omega \rho (1-w) e[\bm{q}_2] dV,
\end{aligned}
\end{align}
for potential energy per unit mass $e$. We then introduce the constraint $C$ defined by
\begin{equation}
C = \int_\Omega \bm{\lambda}^T (\bm{v}_1 - \bm{v}_2) \,dV
\end{equation}
where $\lambda\left(\mathbf{x},t\right)$ is a
Lagrange multiplier field. With the Lagrangian $L=T-U+C$, we apply the calculus of variations to obtain the Euler-Lagrange equations for the decomposed system:
\begin{align}
\label{eq:coupling}
%\left\{
\begin{aligned}
\int_\Omega w \rho \bm{a}_1 \,dV = - \int_\Omega w \underbrace{\rho \frac{\delta e}{\delta \bm{q}_1}}_{\frac{\text{Force}}{\text{Volume}}_1} \,dV - \underbrace{\int_\Omega \bm{\lambda}\, dV}_{\textrm{\scriptsize  coupling force}} , \\
\int_\Omega (1-w) \rho \bm{a}_2 \,dV = - \int_\Omega (1-w) \underbrace{\rho \frac{\delta e}{\delta \bm{q}_2}}_{\frac{\text{Force}}{\text{Volume}}_2} \,dV + \underbrace{\int_\Omega \bm{\lambda}\, dV}_{\footnotesize\textrm{\scriptsize  coupling force}} ,
\end{aligned}
%\right.
\end{align}
under the kinematic constraint that $\bm{v}_1=\bm{v}_2$. The Lagrange multiplier can conveniently be interpreted as a coupling force that acts equally and oppositely on both systems, in order to obtain a matching velocity field in both systems. Summing the equations for the two systems recovers the original system, displaying a partition of unity for the decomposition. 

We now replace these two abstract systems with a discrete particle system and a continuum system. We require the stress in the continuum domain to be compatible with the homogenized frictional forces in the discrete domain. This homogenization is realizable through the so-called Christoffersen formula \cite{Christoffersen:1981:Micromechanical}, which relates the continuum stress to the discrete frictional contact forces via:
\begin{align}
\sigma_{ij} = \frac{1}{V} \sum_{\alpha \in contacts}^{N}{\frac{1}{2}(\boldsymbol{f}_i^\alpha \boldsymbol{d}_j^\alpha + \boldsymbol{f}_j^\alpha \boldsymbol{d}_i^\alpha)} , 
\end{align}
where $\sigma_{ij}$ is the (i,j) component of the stress tensor, $V$ is the volume 
about which one is homogenizing the stress, $N$ is the number of contacts in 
that volume, $\boldsymbol{f}_i^\alpha$ is the $i^{th}$ component of the contact 
force vector at the $\alpha^{th}$ contact, and $\boldsymbol{d}_i^\alpha$ is the
$i^{th}$ component of the vector connecting the centroids of the two grains in contact.

\section{Coupling Constraints}
With the integrated equations of motion derived from the Euler-Lagrange equations, we can derive the position and velocity updates for the separate continuum and discrete systems in the hybrid zone, where the Lagrange multiplier acts to correct the two system updates to kinematically agree with each other. The continuum nature of the continuum portion of the simulation allows us to define a velocity field everywhere in the pure continuum and hybrid portions of the domain. The kinematic constraint therefore enforces that at every discrete particle location, the discrete particle velocity is identical to the interpolated continuum velocity field at that location, enforcing the constraint in an averaged continuum sense \cite{Bergou:2007:TTDTS}. Letting the reconciliation zone be defined on a domain $\Omega_R$, and letting $\lambda_k$ represent the constraint force on the $k$th discrete particle, the $p$th
material point moves as
\begin{align}
\begin{aligned}
&\frac{d}{dt} \boldsymbol{q}_p = \bm{v}_p , \\
&\frac{d}{dt} (w_p M_p \bm{v}_p) = \underbrace{\frac{d}{dt} (w_p M_p \bm{v}_p^*) \sum_{k \in \Omega_R} }_{\textrm{\scriptsize unconstrained step}} \hspace{6pt} \underbrace{- \sum_{k \in \Omega_R} \Gamma_{pk}\lambda_k}_{\textrm{\scriptsize constrained step}} ,
\end{aligned}
\end{align}
while the $k$th discrete particle moves as
\begin{align}
\begin{aligned}
&\frac{d}{dt} \boldsymbol{q}_k = \bm{v}_k , \\
&\frac{d}{dt} ((1-w_k) M_k \bm{v}_k) = \underbrace{\frac{d}{dt} ((1-w_k) M_k \bm{v}_k^*)}_{\textrm{\scriptsize unconstrained step}} \underbrace{\hspace{20pt} + \boldsymbol{\lambda}_k  \hspace{20pt} {\frac{d}{dt}}}_{\textrm{\scriptsize constrained step}} ,
\end{aligned}
\end{align}
where $\bm{v}_p^*$ and $v_k^*$ are the predictions from continuum and discrete simulations respectively before coupling forces are added, and
$\Gamma_{pk}$ are material-point to discrete-particle interpolation coefficients, defined by the same basis functions used in the pure continuum region to interpolate the point properties to the grid.

\subsection{Hybrid Coupling Discretization} \label{subsec:hybrid_coupling_discretization}
The hybrid coupling algorithm in the context of the complete simulation routine is now discussed. In order to integrate in time, we choose an explicit scheme for all components: the discrete method, the continuum method, and the hybrid coupling. While the usual stability tradeoff is made in using an explicit scheme over an implicit scheme, we note that the simplification in the system of equations that results is, for now, worth the computational cost. The scheme can therefore be interpreted as a predictor-corrector scheme, where the DEM and MPM algorithms produce predictor quantities, and the hybrid coupling produces a corrector, applied at the end of the step. As an aside we also note that having consistent schemes across all simulations is important for coupling accuracy. Previous attempts were made to couple a contact dynamics method to the explicit MPM method used to advance the continuum. Because contact dynamics is implicit, the scheme produces a result that is consistent with the constraints defined only in the pure discrete system. Applying a corrector step to the the resulting quantities essentially throws away these constraint. Contact dynamics also assumes completely rigid particles, which does not match the finite elasticity of the constitutive law used for the continuum. The macroscopic phenomenological effects of these discrepancies was that discrete particles slowly drifted through static hybrid zones.

Thus using the explicit schemes previously described, the hybrid coupling occurs as follows. First, an unconstrained step is taken by the discrete method, producing discrete predictor momentum $M_dv^*_d$ and forces $f^*_d$. The predictor position is discarded. An unconstrained MPM step is then taken up to and including the updateNodalMomentum step of Algorithm \ref{alg:MPM_algorithm}, resulting  resulting in continuum predictor momentum $M_cv^*_c$ and forces $f^*_c$ defined on the grid. The hybrid weight field in the hybrid zone $w$ is incorporated into the DEM by multiplying the spring constants $k_n$ and $k_t$ by $1-w$ and the mass of each particle by $1-w$, when solving for the forces on each grain at the $Force\_Update$ step of Algorithm \ref{alg:DEM_algorithm}. In the continuum, the stress and mass are weighted by $w$, which appear any time the mass or stresses are projected to and from the grid. The predictor quantities form the RHS of a system of equations for the corrected coupled system, which in matrix form is defined as:
\begin{align}
\begin{bmatrix}
    W_c M_c & 0 & \Gamma_c \\
    0 & W_d M_d & -\Gamma_d \\
    \Gamma_c^T & -\Gamma_d^T & 0
\end{bmatrix}
\begin{bmatrix}
    \bm{v}_c^{n+1} \\
    \bm{v}_d^{n+1} \\
    \lambda
\end{bmatrix}
=
\begin{bmatrix}
    W_c \left( M_c \bm{v}^*_c + h \bm{f}^*_c \right) \\
    W_d \left( M_d \bm{v}^*_d + h \bm{f}^*_d \right) \\
    0
\end{bmatrix}
\label{eq:coupled_system}
\end{align}
where $W_c$ and $W_d$ are diagonal matrices that contain the mass weights for the continuum and discrete systems and $\bm{\lambda}$ are the Lagrange multipliers. Solving the linear system gives the corrected continuum and discrete velocities $\bm{v}_c^{n+1}$ and $\bm{v}_d^{n+1}$.
$\Gamma_d$ and $\Gamma_c$ are defined such that
$\Gamma_d^T \bm{v}_d - \Gamma_c^T \bm{v}_c$ produces the residual relative velocity of discrete bodies within the background
velocity field defined by the material point grid. Thus $\Gamma_d$ is the identity matrix,
while each column of $\Gamma_c$ contains the combination of weights, obtained from the MPM basis functions, that reconstruct a DEM grain's mass. We use as arguments for the basis functions $\bm{x}^n_p$ and $\bm{x}^n_d$, the positions of the material points and discrete bodies respectively at the beginning of the unconstratined steps.

With the corrected constrained velocities for both systems, we communicate this information back to the DEM and MPM algorithm. The discrete grains are advected according to the corrected velocity $v^{n+1}_d$, completing a discrete timestep. In the MPM simulation, we overwrite the * momentuma on the nodes obtained after the updateNodalMomentum step, and proceed with the rest of the MPM algorithm. With these separate systems evolved, the hybrid step is complete.

\subsection{Nodal Coupling}
While this method to compute coupling forces indeed works, a further speedup is possible by defining a second background
grid that is co-located with the background MPM grid. The velocities of the discrete bodies can be projected to this
second grid as if they were material points. The constraint matrices $\Gamma_d$ and $\Gamma_c$ now reduce to the
identity, and the system in \eqref{eq:coupled_system} can be solved in closed form \eqref{eq:inexpensive_coupling}, giving the system of equations:
\begin{align}
W_c M_c \bm{v}_c^{n+1} + \lambda &= W_c M_c \bm{v}^*_c , \label{eq:sys_a} \\
W_d M_d \bm{v}_d^{n+1} - \lambda &= W_d M_d \bm{v}^*_d , \label{eq:sys_b} \\
\bm{v}_c^{n+1} &= \bm{v}_d^{n+1} . \label{eq:sys_c}
\end{align}
Substituting $\bm{v}_c^{n+1}$ for $\bm{v}_d^{n+1}$ in Eq. \eqref{eq:sys_a}, adding Eq. \eqref{eq:sys_a} and Eq. \eqref{eq:sys_b},
and solving for $\bm{v}_d^{n+1}$, we find that:
\begin{align}
\label{eq:inexpensive_coupling}
\bm{v}_c^{n+1} = \bm{v}_d^{n+1} = \left( W_c M_c + W_d M_d \right)^{-1} \left( W_c M_c \bm{v}_c^* + W_d M_d \bm{v}_d^* \right) .
\end{align}
For diagonal mass matrices, each degree of freedom can be solved for independently, and the formula reduces to an
inelastic impact between two particles in one dimension.

Crucially, the solution at each grid
node is independent of the other grid nodes, and takes the simple form of an inelastic collision between two particles
with masses and velocities equal to those of the grid node (Alg. \ref{alg:hybrid_constraint_solve}). This method to compute hybridization forces is simple, robust, and
trivially parallelized. After solving this system, the discrete grid-based velocities are mapped back to the discrete
bodies in the same manner as MPM points. We always employ this grid vs. grid hybridization technique, and never directly solve the linear system \eqref{eq:coupled_system}.

\section{Domain Decomposition}

\subsection{Oracle}

\begin{figure}[htp] 
    \centering
    \includegraphics[width=0.8\textwidth]{figs/hybrid_zone_update.pdf}
    \caption{Initialization of a hybrid simulation: (A) We begin with a collection of DEM grains. (B) We next locate a level
    set corresponding to a given low density, here denoted as a black line. (C) Across the domain, we compute
    the distance to the density threshold, indicated by lines in lighter shades of red as the distance increases.
    (D) We select a user-tunable distance to the density level-set that serves as the center of the hybrid
    ``reconciliation" zone. We denote this critical distance as a solid black line. (E) We extend the hybrid zone
    along the distance field by a given half-width in each direction, indicated by dotted lines. This hybrid
    reconciliation zone between the dotted lines defines a zone where the DEM system will be coupled to the
    continuum system. We homogenize the velocity and stress for use in step (G). (F) We delete all discrete grains that fall within the inner boundary of the reconciliation zone.
    (G) We run the "avoid-a-void" algorithm of Yue et al. \cite{Yue:2015:Continuum} from the outer boundary in to populate the region with material points. The material point states are determined using the homogenized velocity and stress computed in step (E).}
    \label{hybrid_initialization}
\end{figure}
Critical to our hybridization method is an oracle that is able to flag regions of the simulation domain as safe for a
continuum treatment. Regions are unfit for a continuum treatment when one of any number of conditions are satisfied.
First, in regions of low pressure, grains are more likely to separate from the material bulk and undergo ballistic
motion. Second, high strain rate gradients suggest that the granular flow varies too rapidly to be safely represented as
a homogenized continuum \cite{Dijksman:2010:Granular,Kamrin:2010,Koval:2009:Annular}. Finally, in thin flows,
grain-level dynamics can dominate, leading to finite size effects (e.g., clogging) not captured by local continuum models
\cite{Beverloo:1961:Flow,Midi:2004:Dense,Pouliquen:1999:Scaling,Sheldon:2010:Granular}. We have found that the packing
fraction serves as an effective signal for these sources of fundamentally discrete behavior. The emphasis on packing fraction
is further motivated by the fact that graphical fidelity should be retained on the exterior of granular systems of interest, as it is this
low packing fraction exterior that is seen by an observer.

Our oracle begins by computing the packing fraction of the discrete particle system on a uniform background grid. Note
that only discrete grains are considered when computing the packing fraction, as continuum and hybrid regions are, by
ansatz, considered sufficiently dense. From this implicit representation, we extract an isocontour corresponding to a
critical, threshold packing fraction $\Phi_\rho$ (Fig.~\ref{fig:hybrid:hybrid_initialization} (B)). We next compute the distance $\Phi_d(\bm{x})$ to this threshold isocontour on a second, uniform grid (C), and define an isocontour corresponding to a user specified distance $\phi_0$ as the centerline of the reconciliation zone (D). We label a zone as hybrid if the distance from the centerline is within a given half-width $r_h$, i.e. $\phi_0 - r_h \leq \Phi_d(\bm{x}) \leq \phi_0 + r_h$. Similary, we label a zone as continuum if $\Phi_d(\bm{x}) > \phi_0 - r_h$ and a zone as discrete if $\Phi_d(\bm{x}) < \phi_0 + r_h$ (Alg. \ref{alg:identify_hybrid_zones}).
%See Figure \ref{fig:hybrid:hybrid_initialization} for an example of initializing a
%hybrid simulation from purely discrete initial conditions.

\subsection{Homogenization and Enrichment}
\label{sec:enrichment}
After updating the boundary between simulation domains, we are faced with four possible transition scenarios: a
previously hybrid zone is now purely discrete, a previously hybrid zone is now purely continuum, a previously discrete
zone is now hybrid, or a previously continuum zone is now hybrid. Note that after initialization, we do not permit
direct transitions from continuum to discrete regions or vice versa. The transition away from a hybrid representation is
quite simple. For a hybrid region transitioning to a purely discrete region, we simply delete all material points in the
region. Similarly, for a hybrid region transitioning to a purely continuum region, we delete all discrete grains in the
region. The transition to a hybrid representation is more involved, however. A region that previously contained only
material points will require the insertion of discrete grains. Likewise, a previously discrete region will require the
insertion of new material points. See Alg. \ref{alg:update_hybrid_zones}.

The problem of adding samples to a dynamic simulation was addressed in the context of the material point method with the
recently proposed avoid-a-void algorithm \cite{Yue:2015:Continuum}. The avoid-a-void method applies Poisson disc
sampling to maintain approximately constant material point distributions and to prevent the formation of non-physical
voids within a simulated material. This technique is perfectly suited to our needs, where we need to insert material
points or discrete grains in regions of high material density recently labeled as hybrid. 


For discrete grains, the new
position is determined by the Poisson disc sampling procedure, while we draw the radius of new grains from the same
normal distribution used to generate the initial grain radii. The initial velocity of new discrete grains is computed by
averaging the velocity of surrounding discrete grains and material points within a radius of $6$ (mean) grain diameters, with an exponential
falloff (Alg. \ref{alg:create_discrete_grain}). This window width is slightly above the minimal size that recovers
continuum-like quantities in a ``granular volume element'' \cite{Rycroft:2009}. These nearest neighbor queries are
accelerated with a uniform background grid. 

We first determine the positions of new material points with Poisson disc sampling. Next, we compute the velocity,
(normalized) strain, and deformation gradient magnitude of new points with \textit{homogenization}.
We utilize a regular grid to rasterize the velocity of discrete grains; after rasterizing each discrete grain's mass and
momentum to the grid (using the same rasterization procedure as MPM), we divide the rasterized momentum by the rasterized
mass to determine each grid node's velocity. Likewise, we estimate the \textit{homogenized} stress at grid nodes using
a modification of the Christoffersen formula \cite{Christoffersen:1981:Micromechanical} that yields smooth stress 
fields via the MPM shape functions, as described in Alg. \ref{alg:homogenize_stress}.
After computing the homogenized velocities and stresses at nodes, we use the MPM shape functions to evaluate
the velocity and stress at the newly generated material point positions. Finally, we convert the interpolated stress to
strain: from the definition of the Kirchhoff stress, we can relate the Cauchy stress and the strain via
$\bm{\sigma} = \frac{\kappa}{2} \frac{\left( J^2 - 1 \right)}{J} \boldsymbol{I} + \frac{\mu}{J} dev[\bar{\boldsymbol{b}}^e]$.
By taking the trace of both sides, we obtain $Tr[ \bm{\sigma} ] = \frac{3 \kappa}{2} \frac{\left( J^2 - 1 \right)}{J}$ (in 3D)
and solve for $J$. Next, by taking the deviator of both sides, we obtain $dev[\bar{\boldsymbol{b}}^e] = \frac{J}{\mu} dev[\bm{\sigma}]$.
Finally, $\bar{\boldsymbol{b}}^e$ is given in the form $\bar{\boldsymbol{b}}^e = dev[\bar{\boldsymbol{b}}^e] + t \boldsymbol{I}$,
and we solve for $t$ with $det[\bar{\boldsymbol{b}}^e] = 1$.

We emphasize the importance of syncing the stress and strain during homogenization to
preserve volume. Previously, we initialized new continuum elements to a stress-free state.
This stress-free initialization caused the material to gain volume if the discrete grains were between a gaseous
and liquid state while separating, however.

\subsection{Layered Hybridization}
\label{sec:layered_3D}
We often found it beneficial to only use the discrete treatment for the topmost visible portion of a granular assembly. If the boundary treatment (at the side walls and floor) with the continuum elements is physically valid, and if the continuum elements are invisible from the outside, this \textit{layered hybridization} approach yields additional speed improvements. We apply this approach to the bunny toss, excavator, bunny drill, and tire examples in Section~\ref{sec:results}.

\begin{algorithm}
\caption{${\tt Identify \_ Hybrid \_ Zones}$}
\begin{algorithmic}[1]
\State $\Phi_{\rho} \gets {\tt Discrete \_ Packing \_ Fraction \_ Isocontours}\left(\boldsymbol{q}_d\right)$
\State $\Phi_{d} \gets {\tt Distance \_ to \_ Density \_ Isocontours}\left(\Phi_{\rho}\right)$
\State ${\tt continuum \_ zone}\left( \mathbf{x} \right) \gets \Phi_{d}\left( \mathbf{x} \right) > \phi_0 - r_h$
\State ${\tt discrete \_ zone}\left( \mathbf{x} \right) \gets \Phi_{d}\left( \mathbf{x} \right) < \phi_0 + r_h$
\State ${\tt hybrid \_ zone}\left( \mathbf{x} \right) \gets \phi_0 - r_h \leq \Phi_{d}\left( \mathbf{x} \right) \leq \phi_0 + r_h$
\end{algorithmic} \label{alg:identify_hybrid_zones}
\end{algorithm}

\begin{algorithm}
\caption{${\tt Update \_ Hybrid \_ Zones}$}
\begin{algorithmic}[1]
\State ${\tt Homogenize \_ Velocity \_ and \_ Stress}\left( {\tt hybrid \_ zone} \right)$ 
\State ${\tt Discrete \_ Avoid \_ a \_ Void}\left( {\tt hybrid \_ zone} \right)$ 
\State ${\tt Continuum \_ Avoid \_ a \_ Void}\left( {\tt hybrid \_ zone} \right)$ 
\State ${\tt Delete \_ Discrete \_ Grains}\left( {\tt continuum \_ zone} \right)$ 
\State ${\tt Delete \_ Continuum \_ Particles}\left( {\tt discrete \_ zone} \right)$ 
\end{algorithmic} \label{alg:update_hybrid_zones}
\end{algorithm}

\begin{algorithm}
\caption{${\tt Update \_ Hybrid \_ State}$}
\begin{algorithmic}[1]
\State ${\tt Identify \_ Hybrid \_ Zones}$
\State ${\tt Update \_ Hybrid \_ Zones}$
\end{algorithmic} \label{alg:update_hybrid_state}
\end{algorithm}

\begin{algorithm}
\caption{${\tt Create \_ Discrete \_ Grain}$}
\begin{algorithmic}[1]
\State $\mathbf{x} \gets {\tt Position \_ from \_ Avoid \_ a \_ Void}$
\State $r \gets N\left( r_{mean}, r_{sigma} \right)$ \Comment{Normally distributed radii}
\State $m \gets \frac{4}{3} \pi r ^ 3$
\State $\mathbf{v} \gets 0$
\State $W \gets 0$
\For{$i=0 \dots N_d$} \Comment{Iterate over discrete grains}
  \If{$\left| \mathbf{x}_i - \mathbf{x} \right| < 12 \ r_{mean}$}
    \State $w \gets e^{ \left| \mathbf{x}_i - \mathbf{x} \right|^2 / 2 r_{mean}^2}$
    \State $\mathbf{v} \gets \mathbf{v} + w \ \mathbf{v}_i$
    \State $W \gets W + w$
  \EndIf
\EndFor
\For{$i=0 \dots N_c$} \Comment{Iterate over material points}
  \If{$\left| \mathbf{x}_i - \mathbf{x} \right| < 12 \ r_{mean}$}
    \State $w \gets e^{ \left| \mathbf{x}_i - \mathbf{x} \right|^2 / 2 r_{mean}^2}$
    \State $\mathbf{v} \gets \mathbf{v} + w \ \mathbf{v}_i$
    \State $W \gets W + w$
  \EndIf
\EndFor
\State $\mathbf{v} \gets \mathbf{v} / W$
\end{algorithmic} \label{alg:create_discrete_grain}
\end{algorithm}

\begin{algorithm}
\caption{${\tt Homogenize \_ Velocity \_ and \_ Stress}$}
\begin{algorithmic}[1]
\For{each ${\tt body} \in {\tt Discrete \_ Grains}$}
  \For{${\tt node} \in {\tt Stencil(body)}$}
    \State $w \leftarrow {\tt Weight(body, node)}$
    \State ${\tt node.m } \pluseq w \cdot {\tt body.m }$
    \State ${\tt node.momentum} \pluseq w \cdot {\tt body.m } \cdot {\tt body.}\bm{v}$
  \EndFor    
\EndFor
\For{${\tt node} \in {\tt Grid \_ Nodes}$}
  \If{${\tt node.m} > 0$}
    \State ${\tt homogenized \_ velocity} \leftarrow {\tt node.momentum} /  {\tt node.m}$
  \EndIf
\EndFor
\For{each ${\tt c} \in {\tt collisions}$}
  \For{${\tt node} \in {\tt Stencil(c)}$}
    \State $w \leftarrow {\tt Weight(c, node)}$
    \State $\boldsymbol{f}_c \leftarrow {\tt c}.{\tt collision \_ force}$ \Comment{Normal and friction forces}
    \State $\boldsymbol{r}_c \leftarrow {\tt c}.{\tt arm \_ vector}$
    \State $\bm{\sigma}_c \leftarrow \frac{1}{2} \left( \boldsymbol{f}_c  \boldsymbol{r}_c^T + \boldsymbol{r}_c \boldsymbol{f}_c^T \right)$
    \State ${\tt homogenized \_ stress } \pluseq w \cdot \bm{\sigma} / {\tt cell \_ volume}$
  \EndFor
\EndFor
\end{algorithmic} \label{alg:homogenize_stress}
\end{algorithm}

\begin{algorithm}
\caption{${\tt Discrete \_ Avoid \_ a \_ Void}$}
\begin{algorithmic}[1]
  \For {${\tt cell} \in {\tt Hybrid \_ Zone}$}
    \For {$i=0 \dots {\tt Max \_ Iters}$}
      \State ${\tt Create \_ Discrete \_ Grain}()$
    \EndFor
  \EndFor
\end{algorithmic} \label{alg:discrete_avoid_a_void}
\end{algorithm}

\begin{algorithm}
\caption{${\tt Create \_ Continuum \_ Particle]}$}
\begin{algorithmic}[1]
\State $\mathbf{x} \gets {\tt Position \_ from \_ Avoid \_ a \_ Void}$
\end{algorithmic} \label{alg:create_continuum_particle}
\end{algorithm}

\begin{algorithm}
\caption{${\tt Reassign \_ Hybrid \_ Continuum \_ Properties}$}
\begin{algorithmic}[1]
  \For {${\tt point} \in {\tt Cell}$}
    \State ${\tt point.m} \leftarrow {\tt mpm \_ mass \_ per \_ cell} / ({\tt \#points} \in {\tt Cell}) $
    \State ${\tt point.vol} \leftarrow {\tt cell \_ volume} / ({\tt \#points} \in {\tt Cell}) $
    \State ${\tt point.}\boldsymbol{v} \leftarrow {\tt homogenized \_ velocity} ({\tt point.}\boldsymbol{x}) $
    \State $\boldsymbol{\sigma} \leftarrow {\tt homogenized \_ stress} ({\tt point.}\boldsymbol{x})$ 
    \State ${\tt point.strain} \leftarrow {\tt convert \_ stress \_ to \_ strain} (\boldsymbol{\sigma}) $
  \EndFor
\end{algorithmic} \label{alg:determine_properties_for_hybrid_continuum_particles}
\end{algorithm}

\begin{algorithm}
\caption{${\tt Determine \_ New \_ Inner \_ Continuum \_ Properties}$}
\begin{algorithmic}[1]
  \For {${\tt newly \_ sampled \_ point} \in {\tt Cell}$}
    \State ${\tt point.m} \leftarrow {\tt gather \_ mass \_ of \_ extant \_ nghbr \_ pnts} $
    \State ${\tt point.vol} \leftarrow {\tt gather \_ vol \_ of \_ extant \_ nghbr \_ pnts} $
    \State ${\tt point.}\boldsymbol{v} \leftarrow {\tt interp \_ vel \_ of \_ extant \_ nghbr \_ pnts} $
    \State ${\tt point.strain} \leftarrow {\tt interp \_ strn \_ of \_ extant \_ nghbr \_ pnts} $
  \EndFor
\end{algorithmic} \label{alg:determine_properties_for_new_inner_continuum_particles}
\end{algorithm}

\begin{algorithm}
\caption{${\tt Continuum \_ Avoid \_ a \_ Void}$}
\begin{algorithmic}[1]
  \For {${\tt cell} \in {\tt Hybrid \_ Zone}$}
    \For {$i=0 \dots {\tt Max \_ Iters}$}
      \State ${\tt Create \_ Continuum \_ Particle}()$
    \EndFor
    \State ${\tt Reassign \_ Hybrid \_ Continuum \_ Properties}$
  \EndFor
  \For {${\tt cell} \in {\tt Continuum \_ Zone}$}
    \For {$i=0 \dots {\tt Max \_ Iters}$}
      \State ${\tt Create \_ Continuum \_ Particle}()$
    \EndFor
    \State ${\tt Determine \_ New \_ Inner \_ Continuum \_ Properties}$ 
  \EndFor
\end{algorithmic} \label{alg:continuum_avoid_a_void}
\end{algorithm}

\begin{algorithm}
  \caption{${\tt Delete \_ Discrete \_ Grains}$}
  \begin{algorithmic}[1]
  \For{${\tt body} \in {\tt Discrete \_ Grains}$}
    \If{${\tt body} \in {\tt Continuum \_ Zone}$}
      \State ${\tt delete} \left({\tt body}\right)$  
    \EndIf
  \EndFor
  \end{algorithmic}
  \label{alg:delete_discrete_grains}
\end{algorithm}

\begin{algorithm}
  \caption{${\tt Delete \_ Continuum \_ Particles}$}
  \begin{algorithmic}[1]
  \For{${\tt point} \in {\tt Material \_ Points}$}
    \If{${\tt point} \in {\tt Discrete \_ Zone}$}
      \State ${\tt delete} \left({\tt point}\right)$  
    \EndIf
  \EndFor
  \end{algorithmic}
  \label{alg:delete_continuum_particles}
\end{algorithm}
